# Contributor: Julien Portalier <julien@portalier.com>
# Maintainer: Julien Portalier <julien@portalier.com>
pkgname=crystal
pkgver=0.20.2
pkgrel=1
pkgdesc="Crystal programming language"
url="http://crystal-lang.org/"
arch="all"
license="ASL 2.0"
depends="gc-dev libc-dev libevent-dev pcre-dev"
makedepends="bash llvm-dev llvm-static ncurses-dev zlib-dev"
install=""
subpackages=""
source="
	saveas-https://github.com/crystal-lang/crystal/archive/$pkgver.tar.gz/$pkgname-$pkgver.tar.gz
	crystal
    fix-dwarf-line-numbers-with-musl.patch
	"
_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"
    patch -p1 < "$srcdir"/fix-dwarf-line-numbers-with-musl.patch
}

build() {
	cd "$_builddir"
	export CRYSTAL_CONFIG_VERSION=$pkgver
	make release=1 || return 1
}

package() {
	local _bindir="$pkgdir"/usr/bin
	local _libdir="$pkgdir"/usr/lib/crystal

    mkdir -p $_bindir $_libdir

	cp "$srcdir"/crystal "$_bindir"/crystal
	cp "$_builddir"/.build/crystal "$_bindir"/crystal-binary
	cp -r "$_builddir"/src "$_libdir"/

	find "$_bindir" -type f -exec chmod 0755 {} \;
	find "$_libdir"/ -type d -exec chmod 0755 {} \;
	find "$_libdir"/src -type f -exec chmod 0644 {} \;
}
md5sums="25a4c3799ac3d80e6a52babaa2f57cb0  crystal-0.20.2.tar.gz
6385fa702633a19abafb50cbc4e3e6fe  crystal
2dba6a7f9e30d63e443fa4e277ea710f  fix-dwarf-line-numbers-with-musl.patch"
sha256sums="7478f2f8d75f373ebbc76baec57fb85b31ed129c5015eae0d5c685e02986c603  crystal-0.20.2.tar.gz
aff61e7c3685133a827930822dacc30a831b27b40cb3d03a26df91f9f6f3a9ed  crystal
35dad9df79a69e903677109b1d0e667c3ec42509ac4b78571af39a8a979ae060  fix-dwarf-line-numbers-with-musl.patch"
sha512sums="64db63a1bee14a69a8465ec39bf3648d3857a16dff7bbe928a7a97b1c0ee55b20384de2344c89d1123f4a2acabb5a13dc75537b13852758768f25716f1d1f401  crystal-0.20.2.tar.gz
1f77a528d3dd5ca041a95bd97902c9f6a246fdeab7ceee538704f34bf3003b482f660d0fffeb0c538856767eac93610fe092b7c71d8e6736bd1919bd0cf6e2e5  crystal
c71b278f481b3d7c69ca7429fa01768df3d3c3ade1613ce003c742cdd65cdec8de6b4089152170e9be2b31e62eb9ffbe2b3d0c4d546f3f98febfd1e33bd3bbf7  fix-dwarf-line-numbers-with-musl.patch"
