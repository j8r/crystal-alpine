# Contributor: Julien Portalier <julien@portalier.com>
# Maintainer: Julien Portalier <julien@portalier.com>
pkgname=crystal
pkgver=0.19.4
pkgrel=2
pkgdesc="Crystal programming language"
url="http://crystal-lang.org/"
arch="all"
license="ASL 2.0"
depends="gc-dev libc-dev libevent-dev pcre-dev"
makedepends="bash llvm-dev llvm-static ncurses-dev zlib-dev"
install=""
subpackages=""
source="
	saveas-https://github.com/crystal-lang/crystal/archive/$pkgver.tar.gz/$pkgname-$pkgver.tar.gz
	crystal
    x86.patch
	"
_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"
}

build() {
	cd "$_builddir"
    patch -p1 < "$srcdir"/x86.patch
	export CRYSTAL_CONFIG_VERSION=$pkgver
	make release=1 || return 1
}

package() {
	local _bindir="$pkgdir"/usr/bin
	local _libdir="$pkgdir"/usr/lib/crystal

    mkdir -p $_bindir $_libdir

	cp "$srcdir"/crystal "$_bindir"/crystal
	cp "$_builddir"/.build/crystal "$_bindir"/crystal-binary
	cp -r "$_builddir"/src "$_libdir"/

	find "$_bindir" -type f -exec chmod 0755 {} \;
	find "$_libdir"/ -type d -exec chmod 0755 {} \;
	find "$_libdir"/src -type f -exec chmod 0644 {} \;
}

md5sums="27ebd5a7add2863d0241343f95df7075  crystal-0.19.4.tar.gz
dc2b929a6b4dc811a10f3379fc42b05c  crystal
362aca53e484f15546ead26f7e82675a  x86.patch"
sha256sums="e239afa449744e0381823531f6af66407ba1f4b78767bd67a9bb09d9fcc6b9e4  crystal-0.19.4.tar.gz
61f19f4ac097b58f6613b01d9cefef10aee79474d2abf93889afec75f7d2a425  crystal
5e92959b7a6a5b17df495f3aa997d9babd8482aefd9f90edf62870b0db623c87  x86.patch"
sha512sums="44127cbe022dfb596bab25d0d617f41e013537584f52d31df891c716a6b23612fc7e28a7000a1d02378f7a7410745f22e703084070f7e2bc61d467192e924505  crystal-0.19.4.tar.gz
933cceea1f59055450104e37ef7230038dadb2a5e24bceb011151f43c7738a544334eb411f77760f8be3cbcffe65c56ce88d1e377b7ac6d2e6006eda199749fd  crystal
2cd8e6f3061891e5994327a0a295bd9650334864302fab5470d95ec2483418f40db1d36e0635b618b3889cfd905d4710766a343e944fced404a6a52daeddc8d5  x86.patch"
