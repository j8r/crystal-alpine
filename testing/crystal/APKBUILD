# Contributor: Julien Portalier <julien@portalier.com>
# Maintainer: Julien Portalier <julien@portalier.com>
pkgname=crystal
pkgver=0.12.0
pkgrel=4
pkgdesc="Crystal programming language"
url="http://crystal-lang.org/"
arch="all"
license="ASL 2.0"
depends="gc llvm-libs libevent pcre ncurses-libs zlib"
makedepends="bash build-base clang gc-dev libevent-dev llvm-dev pcre-dev ncurses-dev zlib-dev"
install=""
subpackages=""
source="
	saveas-https://github.com/crystal-lang/crystal/archive/$pkgver.tar.gz/$pkgname-$pkgver.tar.gz
	0001-Set-compiler-flags-from-target-triple.patch
	0002-Compile-against-musl-libc-Errno.patch
	0003-Use-tzset-and-timezone-on-Linux.patch
	crystal
	"
_builddir="$srcdir"/$pkgname-$pkgver

prepare() {
	cd "$_builddir"
	patch -p1 -i "$srcdir"/0001-Set-compiler-flags-from-target-triple.patch || return 1
	patch -p1 -i "$srcdir"/0002-Compile-against-musl-libc-Errno.patch || return 1
	patch -p1 -i "$srcdir"/0003-Use-tzset-and-timezone-on-Linux.patch || return 1
}

build() {
	cd "$_builddir"
	export CC=clang CXX=clang++ CRYSTAL_CONFIG_VERSION=$pkgver
	make release=1 || return 1
}

package() {
	local _bindir="$pkgdir"/usr/bin
	local _libdir="$pkgdir"/usr/lib/crystal

    mkdir -p $_bindir $_libdir

	cp "$srcdir"/crystal "$_bindir"/crystal
	cp -r "$_builddir"/src "$_libdir"/
	cp "$_builddir"/.build/crystal "$_libdir"/crystal-binary

	find "$_libdir"/ -type d -exec chmod 0755 {} \;
	find "$_bindir" "$_libdir" -type f -exec chmod 0755 {} \;
	find "$_libdir"/src -type f -exec chmod 0644 {} \;
}

md5sums="8acac4d1ed3e9021a3120670a553754d  crystal-0.12.0.tar.gz
9e6cf7f8099ebf358e23d4803e88b1c7  0001-Set-compiler-flags-from-target-triple.patch
5e242a679e7344019b1bfd62c2f04155  0002-Compile-against-musl-libc-Errno.patch
09ba12b858ed52cbe9b73ad85593bdd7  0003-Use-tzset-and-timezone-on-Linux.patch
e94169a0db742837fce3fafe11754efa  crystal"
sha256sums="918bad9b906fe252f3f66685487892ad7c13a31135aa5874ac1e52ea399328e3  crystal-0.12.0.tar.gz
b2c6f21b889dd84295f3592ecb20b1773d15c14e60c6f4649bd15239872d74f5  0001-Set-compiler-flags-from-target-triple.patch
e466339ec3fcfb682449ed9faea16cb905f5b4662905729e0a2051047c92b603  0002-Compile-against-musl-libc-Errno.patch
b98562cf7089bd1e755078bff9f0bc2a2bc4f818b11d82ea4a2b0b63b100b071  0003-Use-tzset-and-timezone-on-Linux.patch
6f4280b2f168a3ddb15f5dcd7029d721c278ec11080d42b4283d0010933472de  crystal"
sha512sums="86ba58e3f69ecada49a8e6596f49cc4e4becb109c2725b9436eb5aa587c247aa4c309242e3fdc5d6a655726595005db4e33fcf868d7c888448c58af74d1b947f  crystal-0.12.0.tar.gz
8eac96f48e2dafe359613da4f698ac7bb2cc7f62d5158de686f2f1bd506af2820fc0ba80f21fdcb5fd73ffae4fd437fa559f6faa3f082ae72efd62afa4d2035c  0001-Set-compiler-flags-from-target-triple.patch
6e63984fc1b249c8a32b0746cb24a7f7f2121f2c857fcb760b1dcf710593e61efb65f7b6d2b3592d46ee737f00afd41a9ddd90b2794b6134c818930123f7b8a9  0002-Compile-against-musl-libc-Errno.patch
67057318fc3254b4de592407bf8868e9d4e6ac7bc97850f4213ff0237a3706b04b18cc56022e3907bbed3d63506a6d6a7331bbc95b39fa1c8dca68b861f29d4c  0003-Use-tzset-and-timezone-on-Linux.patch
e9ee60f378d1e43b89753ae337c5133d4b0c92edf43ea20d5b1d69f91716729de3e61145d8c1cc5d14e468c76d4f26269e32be7c3fbbe7afd2b6278de85bae0b  crystal"
