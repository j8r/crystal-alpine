From 690ab640a5168c914b726bb88926d285ff8e883d Mon Sep 17 00:00:00 2001
From: Julien Portalier <julien@portalier.com>
Date: Mon, 8 Feb 2016 17:55:45 +0100
Subject: [PATCH 1/5] Set compiler flags from target triple

---
 src/compiler/crystal/semantic/flags.cr | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/compiler/crystal/semantic/flags.cr b/src/compiler/crystal/semantic/flags.cr
index 9bc2ac3..7c25e5a 100644
--- a/src/compiler/crystal/semantic/flags.cr
+++ b/src/compiler/crystal/semantic/flags.cr
@@ -1,10 +1,10 @@
 class Crystal::Program
   def flags
-    @flags ||= parse_flags(`uname -m -s`)
+    @flags ||= parse_flags(target_machine.triple.split('-'))
   end
 
   def flags=(flags)
-    @flags = parse_flags(flags)
+    @flags = parse_flags(flags.split)
   end
 
   def has_flag?(name)
@@ -18,7 +18,10 @@ class Crystal::Program
   end
 
   private def parse_flags(flags_name)
-    flags_name.split.map(&.downcase).to_set
+    set = flags_name.map(&.downcase).to_set
+    set.add "darwin" if set.any?(&.starts_with?("macosx"))
+    set.add "i686" if set.any? { |flag| %w(i586 i486 i386).includes?(flag) }
+    set
   end
 
   class FlagsEvaluator < Visitor
-- 
2.6.4

